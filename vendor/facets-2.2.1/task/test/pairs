#!/usr/bin/env ratch

# cross-run unit tests
#
# This tool runs all tests against each other in pairs
# to ensure across the board compatibility.

abort "Not working correctly. Fix me."

require "./lib/more/facets/progressbar"

main :test do
  output = "doc/log/crosstest.txt"

  live = ARGV.delete('--live')

  find = 'test/**/test_*.rb'

  tests = Dir.glob(find).reject{ |f| dir?(f) }.sort
  tests = tests.sort{ |a,b| File.basename(a) <=> File.basename(b) }

  File.open(output, 'w'){ |f|
    f << "= CROSS TESTING\n#{Time.now}"
  }

  total = tests.size * tests.size

  pbar = Console::ProgressBar.new("CrossTest", total+1)
  pbar.inc

  tests.each do |file1|
    tests.each do |file2|
      next if file1 == file2

      sh %{echo "\n\n#{file1} & #{file2}" >> #{output}}

      pbar.title = File.basename(file1)
      pbar.inc
      pbar.flush

      if live
        sh %{ruby -r#{file2} #{file1} >> #{output}}
      else
        sh %{ruby -Ilib/more -Ilib/core -Ilib/methods -r#{file2} #{file1} >> #{output}}
      end
    end
  end

  pbar.finish
end
