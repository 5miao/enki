#!/usr/bin/env ratch

# generate changes from history

config = configuration['changes']

history_file = config['history'] || 'log/history.rd'
changes_file = config['changes'] || 'CHANGES'

history_file.to_actual_filename!

name, version = rollrc.name, rollrc.version

main :changes do
  build changes_file
end

file changes_file => [ history_file ] do
  history = File.read(history_file)
  matches = /^==\s*#{version}(.*?)(\n==|\Z)/m.match(history)
  changes = matches[0]
  changes = changes.chomp('==').strip.sub(/^==\s+/, "#{name} ")
  if dryrun?
    puts "#{changes_file} would have been updated (dryrun mode)."
  else
    File.open(changes_file, 'w'){ |f| f << changes }
    puts "#{changes_file} updated."
  end
end
